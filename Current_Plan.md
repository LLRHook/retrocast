# Retrocast — MVP Analysis & Gap Report

> Last updated: 2026-02-15
> Generated by `/analyze` — fresh evidence-based audit

---

## Status Summary

| Area       | Status                        | Completion | Progress                       |
|------------|-------------------------------|------------|--------------------------------|
| Backend    | Feature-complete, fully tested | **100%**   | `█████████████████████` |
| Frontend   | Nearly complete, minor gaps   | **92%**    | `███████████████████░░` |
| Deployment | Functional, needs hardening   | **65%**    | `██████████████░░░░░░░` |
| **Overall**| **~90%**                      |            | `██████████████████░░░` |

**Overall** is weighted: Backend 40%, Frontend 40%, Deployment 20%.

---

## 1. Backend — 100%

**190 tests passing** (`go test -v -race ./...`): handler tests across api, auth, gateway, permissions, snowflake packages. All tests pass with race detector. Zero failures.

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Auth (register, login, refresh, logout) | 1.0 | Tested | `internal/auth/` — 9 tests, `auth_handler.go` 4 endpoints, `auth_handler_test.go` 6 tests |
| 2 | Users (get/update profile) | 1.0 | Tested | `user_handler.go`:14-73, `user_handler_test.go` 7 tests |
| 3 | Guilds (CRUD + auto-setup) | 1.0 | Tested | `guild_handler.go`:19-331, 7 tests, creates @everyone role + general channel |
| 4 | Channels (CRUD, text/voice/category, position) | 1.0 | Tested | `channel_handler.go`:17-249, 7 tests, ChannelType enum, position ordering |
| 5 | Messages (send, list, edit, delete, cursor pagination) | 1.0 | Tested | `message_handler.go`:17-547, 16 tests, before-cursor pagination |
| 6 | Members (list, get, update nick+roles, kick, leave) | 1.0 | Tested | `member_handler.go`:14-338, 11 tests |
| 7 | Roles (CRUD, hierarchy, assign/remove) | 1.0 | Tested | `role_handler.go`:16-461, 11 tests, position/hierarchy checks |
| 8 | Permissions (guild + channel-level) | 1.0 | Tested | `permissions/` — 30 tests, 19 permission bits, 8-layer resolver |
| 9 | Invites (create, accept, list, revoke) | 1.0 | Tested | `invite_handler.go`:15-320, 8 tests, uses tracking, ban check |
| 10 | WebSocket Gateway (HELLO→IDENTIFY→READY, heartbeat, RESUME) | 1.0 | Tested | `gateway/manager_test.go` — 33 tests: lifecycle, subscriptions, dispatch, concurrency |
| 11 | Gateway Events (all CRUD dispatches) | 1.0 | Tested | 19 event types, all dispatch calls verified via mockGateway across handler tests |
| 12 | Typing Indicators | 1.0 | Tested | `message_handler.go` typing endpoint, 2 tests |
| 13 | Rate Limiting (per-IP/per-user, Redis-backed) | 1.0 | Tested | `ratelimit.go`, `ratelimit_test.go` — 4 tests, fail-open on Redis errors |
| 14 | File Uploads (MinIO attachments) | 1.0 | Tested | `upload_handler.go`, `upload_handler_test.go` — 6 tests, 10MB limit, content-type validation |
| 15 | DMs / Private Channels | 1.0 | Tested | `dm_handler.go`, `dm_handler_test.go` — 12 tests, idempotent GetOrCreateDM |
| 16 | Ban System | 1.0 | Tested | `ban_handler.go`:16-231, `ban_handler_test.go` — 7 tests, auto-kick on ban |
| 17 | Handler Test Coverage | 1.0 | Complete | 190 tests, 0 failures, race detector clean, every handler has test file |

**Total: 17.0 / 17 = 100%**

### Minor Observations (not blocking)

1. **Refresh/Logout handler tests** — `auth_handler_test.go` tests Register and Login directly; Refresh and Logout handlers lack dedicated tests (simple token operations).
2. **ListMyGuilds** — No dedicated test for `GET /users/@me/guilds`.
3. **Channel override handler tests** — `SetChannelOverride` and `DeleteChannelOverride` tested indirectly through message handler permission override tests.
4. **Duplicate typing implementations** — Both `gateway/typing.go` and `message_handler.go` have typing handlers. Router uses the gateway one.
5. **Gateway `log.Printf`** — 17 calls in gateway package use stdlib `log.Printf` instead of `slog` (breaks structured JSON logging).

---

## 2. Frontend — 92%

**60 Swift files, ~4,473 lines of code.** XcodeGen project (`project.yml`), builds for iOS Simulator (iPhone 16, iOS 18.4+). `BUILD SUCCEEDED` confirmed.

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Project scaffolded | 1.0 | Complete | `project.yml`, XcodeGen, `Retrocast.xcodeproj`, 60 files |
| 2 | Auth flow (register, login, token management) | 1.0 | Complete | `AuthViewModel`, `TokenManager` (Keychain), auto-refresh with coalescing, `LoginView`, `RegisterView`, `ServerAddressView` |
| 3 | Guild list sidebar | 1.0 | Complete | `ServerListView`, `ServerListViewModel`, `GuildIcon`, context menu, gear icon, wired in `MainView` column 1 |
| 4 | Channel list sidebar | 1.0 | Complete | `ChannelSidebarView`, `ChannelListViewModel` (grouped by category, voice indicators) |
| 5 | Message view + history | 0.75 | Mostly done | `MessageListView`, `MessageRow`, `DateSeparator` — cursor pagination in VM, but **scroll trigger not wired** to call `loadMoreMessages()`; edit/delete context menu items are TODO stubs |
| 6 | Message send + real-time | 1.0 | Complete | `MessageInput`, `ChatViewModel` — typing throttle, optimistic send, gateway event handling |
| 7 | WebSocket client | 1.0 | Complete | `GatewayClient` — HELLO→IDENTIFY→READY, heartbeat, reconnect/RESUME, exponential backoff with jitter |
| 8 | Member list panel | 0.75 | Reachable | `MemberListView` wired as toggleable sidebar (person.2 toolbar button). `UserProfilePopover` exists but **not wired** to MemberRow tap |
| 9 | Typing indicators | 1.0 | Complete | `TypingIndicator` with bouncing dots, `AppState.typingUsers`, throttled sending, auto-removal |
| 10 | Presence indicators | 1.0 | Complete | `PresenceDot`, `PresenceState`, wired in `MemberRow` and `UserProfilePopover` |
| 11 | Settings UI | 0.75 | Mostly done | `UserSettingsView` reachable via gear icon in ServerListView. `AppSettingsView` exists but **unreachable** (no navigation link) |
| 12 | Invite system UI | 1.0 | Complete | `InviteSheet`, `CreateGuildSheet`, `JoinGuildSheet`, `InviteViewModel` — all wired and functional |
| 13 | Role management UI | 1.0 | Complete | `RoleEditorView` with name, color, 19 permission toggles. Create/edit/delete. Wired via GuildSettingsView |
| 14 | Responsive layout | 0.75 | Mostly done | `NavigationSplitView` 3-column in `MainView`, adaptive sidebar. `UIPasteboard` usage blocks macOS compilation |
| 15 | File upload UI | 0.75 | Mostly done | PhotosPicker with paperclip button, multipart upload. Photos only (no document picker). Attachments display as raw URLs, no rich preview |

**Total: 13.75 / 15 = 91.7%**

### Key Gaps

1. **Message pagination scroll trigger** — `MessageListView` has `isLoadingMore` spinner but no mechanism to invoke `viewModel.loadMoreMessages()`. Need an `.onAppear` sentinel or geometry-based scroll trigger near the top of the message list.

2. **Message edit/delete in UI** — `MessageRow` context menu has "Edit Message" and "Delete Message" items with empty `// TODO` closures. `ChatViewModel.editMessage()` and `deleteMessage()` methods exist and work — just need to be called.

3. **UserProfilePopover not wired** — Built with avatar, presence, roles, join date. `MemberRow` has no tap gesture to present it.

4. **AppSettingsView unreachable** — Exists but no navigation from `UserSettingsView`. Needs a `NavigationLink` or section button.

5. **Attachment rendering** — Uploaded files appear as raw URL strings in messages. Need image detection + `AsyncImage` preview in `MessageRow`.

6. **UIPasteboard iOS-only** — `MessageRow` and `InviteSheet` use `UIPasteboard.general.string` which won't compile on macOS. Needs `#if os()` conditional.

### Gap-Filling Instructions

**Message pagination trigger** (`Sources/Views/Chat/MessageListView.swift`):
```
1. Add a sentinel Color.clear view at the TOP of the LazyVStack (before the first message)
2. Attach .onAppear to the sentinel that calls viewModel.loadMoreMessages(channelID:)
3. Guard with: if !viewModel.isLoadingMore && viewModel.hasMoreMessages
4. The loading spinner already exists in the view — it just needs a trigger
```

**Wire edit/delete in MessageRow** (`Sources/Views/Chat/MessageRow.swift`):
```
1. Pass ChatViewModel (or closures) into MessageRow
2. Replace the empty // TODO closures with:
   - Edit: present a TextField alert/sheet, call viewModel.editMessage(messageID:content:channelID:)
   - Delete: call viewModel.deleteMessage(messageID:channelID:) directly (already has confirmation in the context menu)
```

**Wire UserProfilePopover** (`Sources/Views/Members/MemberRow.swift`):
```
1. Add @State private var showProfile = false
2. Wrap the existing HStack in a Button or add .onTapGesture { showProfile = true }
3. Add .popover(isPresented: $showProfile) { UserProfilePopover(member: member) }
```

**Wire AppSettingsView** (`Sources/Views/Settings/UserSettingsView.swift`):
```
1. Add a NavigationLink or button in the bottom section:
   NavigationLink("App Settings") { AppSettingsView() }
2. Or add as a Section in the existing form
```

**Attachment rendering** (`Sources/Views/Chat/MessageRow.swift`):
```
1. Check if message.attachments is non-empty
2. For image attachments (contentType starts with "image/"):
   AsyncImage(url: URL(string: attachment.url)) with placeholder
3. For non-image: show filename + size as a download link
4. Keep message.content as text below/above the attachment preview
```

---

## 3. Deployment — 65%

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Dockerfile (multi-stage) | 0.75 | Partial | `Dockerfile` — 2-stage build, but no non-root user, no HEALTHCHECK, no .dockerignore |
| 2 | docker-compose.yml | 0.75 | Partial | 6 services + volumes, but secrets hardcoded inline, no restart policy, no API healthcheck |
| 3 | CI/CD pipeline | 0.50 | CI only | `.github/workflows/ci.yml` — test + build. No lint, no Docker image push, no CD |
| 4 | Reverse proxy + TLS | 0.75 | Partial | `Caddyfile` — auto HTTPS, but no security headers, no WebSocket tuning, /metrics exposed |
| 5 | Production config separation | 0.50 | Partial | `config.go` env-based, but dev secrets as defaults (JWT_SECRET falls back silently), no validation |
| 6 | Structured logging | 0.50 | Partial | `slog.NewJSONHandler` in `main.go`, but gateway uses 17x `log.Printf`, no configurable log level |
| 7 | Health check endpoint | 0.75 | Partial | `GET /health` returns `{"status":"ok"}` but shallow (no DB/Redis ping), no compose healthcheck on API |
| 8 | Automated DB migrations | 1.0 | Complete | `golang-migrate` runs on startup, 14 migration pairs, exits on failure |
| 9 | Redis persistence | 1.0 | Complete | `--appendonly yes` + named volume in compose |
| 10 | Monitoring (Prometheus) | 0.50 | Partial | `/metrics` endpoint via echoprometheus middleware, but no Prometheus/Grafana in compose, no custom metrics |
| 11 | Backup strategy | 0.50 | Partial | `scripts/backup.sh` with pg_dump, but no automation, no retention, no MinIO backup |
| 12 | .env support | 0.50 | Partial | `.env.example` documents vars, .gitignore excludes .env, but compose hardcodes secrets, no godotenv |
| 13 | Graceful shutdown | 1.0 | Complete | `signal.NotifyContext(SIGINT, SIGTERM)` + `srv.Shutdown()` + deferred pool/redis close |

**Total: 8.50 / 13 = 65.4%**

### Gap-Filling Instructions

**Config validation** (`internal/config/config.go`):
```
1. Remove default values for JWT_SECRET and DATABASE_URL
2. Add validation: if JWT_SECRET == "" { log.Fatal("JWT_SECRET is required") }
3. Same for DATABASE_URL, REDIS_URL
4. Add LOG_LEVEL env var: envOrDefault("LOG_LEVEL", "info"), parse to slog.Level
```

**Dockerfile hardening** (`Dockerfile`):
```
1. Add: RUN adduser -D -u 1001 appuser
2. Add: USER appuser
3. Add: HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://localhost:8080/health || exit 1
4. Create .dockerignore: .git, bin/, *.md, .env*, .claude/
```

**docker-compose hardening** (`docker-compose.yml`):
```
1. Add restart: unless-stopped to all services
2. Replace inline secrets with env_file: .env
3. Add healthcheck to api service:
   healthcheck:
     test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
     interval: 10s
     timeout: 3s
     retries: 3
```

**CI improvements** (`.github/workflows/ci.yml`):
```
1. Add golangci-lint step before tests
2. Add Go module cache via setup-go cache: true
3. Add Docker build step (build-only, no push) to verify Dockerfile
```

**CD pipeline** (`.github/workflows/cd.yml`):
```
1. Trigger on push to main (after CI passes)
2. Build Docker image, push to GHCR (ghcr.io)
3. SSH deploy or use Watchtower for auto-pull
```

**Migrate gateway logging** (`internal/gateway/`):
```
1. Replace all log.Printf in manager.go, connection.go, server.go with slog.Info/slog.Error
2. Add structured fields: "userID", "guildID", "sessionID", "error"
3. Remove import "log" from gateway package
```

**Deep health check** (`internal/api/router.go`):
```
1. Replace shallow /health with a check that pings Postgres (pool.Ping(ctx)) and Redis (rdb.Ping(ctx))
2. Return {"status":"ok","postgres":"ok","redis":"ok"} or 503 with failed component
```

**Prometheus + Grafana** (`docker-compose.yml`):
```
1. Add prometheus service with prometheus.yml scraping api:8080/metrics
2. Add grafana service with provisioned Prometheus datasource
3. Create basic dashboard: request rate, latency p50/p95/p99, error rate, WS connections
```

---

## Priority Matrix

### P0 — Critical for Polished MVP

| Task | Area | Effort | Why |
|------|------|--------|-----|
| Wire message pagination scroll trigger | Frontend | 1 hour | Users can't load older messages — core UX broken |
| Wire edit/delete in MessageRow | Frontend | 1 hour | Context menu items exist but do nothing |
| Config validation (fail-loud on missing secrets) | Deployment | 1 hour | Silent fallback to dev credentials in production |

### P1 — Important for Quality

| Task | Area | Effort | Why |
|------|------|--------|-----|
| Wire UserProfilePopover to MemberRow | Frontend | 30 min | Built but untappable |
| Wire AppSettingsView from UserSettingsView | Frontend | 30 min | Built but unreachable |
| Attachment rendering in MessageRow | Frontend | 2 hours | Uploads show as raw URLs |
| Dockerfile hardening (non-root, healthcheck) | Deployment | 1 hour | Security baseline |
| docker-compose hardening (restart, env_file) | Deployment | 1 hour | Reliability baseline |
| Migrate gateway log.Printf to slog | Deployment | 1 hour | Breaks JSON log aggregation |

### P2 — Polish & Extended Features

| Task | Area | Effort | Why |
|------|------|--------|-----|
| CI: Add golangci-lint + Go cache | Deployment | 1 hour | Code quality + faster CI |
| CD pipeline (auto-deploy on merge) | Deployment | 0.5 day | Currently CI only |
| Deep health check (DB + Redis ping) | Deployment | 1 hour | Shallow check misses outages |
| Prometheus + Grafana in compose | Deployment | 0.5 day | Monitoring visibility |
| UIPasteboard → cross-platform clipboard | Frontend | 30 min | Enables macOS builds |
| Document picker for non-image uploads | Frontend | 2 hours | Currently photos only |
| Message search | Frontend + Backend | 1-2 days | Feature parity with Discord |
| Read states / unread counts | Backend + Frontend | 1-2 days | UX polish — unread badges |
| Voice channels (LiveKit) | Frontend + Backend | 3-5 days | Major feature, LiveKit server already in compose |
| Backup automation (cron + MinIO) | Deployment | 2 hours | Currently manual script only |

---

## Cumulative Progress

| Milestone | Backend | Frontend | Deployment | Overall |
|-----------|---------|----------|------------|---------|
| Session start (initial) | 74% | 5% | 50% | 42% |
| After Sprint 1 autopilot | 94% | 55% | 88% | 77% |
| After P0+P1 sprint | 96% | 58% | 87% | 79% |
| **Current (fresh audit)** | **100%** | **92%** | **65%** | **90%** |

### Evidence
- `go build ./cmd/retrocast` — compiles clean
- `go test -race ./...` — **190 tests passing**, 0 failures
- `xcodebuild -scheme Retrocast -destination 'iPhone 16,OS=18.4'` — **BUILD SUCCEEDED**
- 60 Swift files, ~4,473 LOC
- 13 files changed in latest PR #6 (1,767 insertions)
- Permission bits verified: all 19 + Administrator match between backend and frontend
