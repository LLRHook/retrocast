# Retrocast — MVP Analysis & Gap Report

> Last updated: 2026-02-15
> Generated by `/analyze` — fresh evidence-based audit

---

## Status Summary

| Area       | Status                        | Completion | Progress                       |
|------------|-------------------------------|------------|--------------------------------|
| Backend    | Feature-complete for MVP      | **96%**    | `████████████████████░` |
| Frontend   | SwiftUI app compiles + runs   | **58%**    | `████████████░░░░░░░░░` |
| Deployment | Prod-ready infra              | **87%**    | `██████████████████░░░` |
| **Overall**| **~79%**                      |            | `████████████████░░░░░` |

**Overall** is weighted: Backend 40%, Frontend 40%, Deployment 20%.

---

## 1. Backend — 96%

**145 tests passing** (`go test -v -race ./...`): handler tests across api, auth, permissions, snowflake packages. All tests pass with race detector.

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Auth (register, login, refresh, logout) | 1.0 | Tested | `internal/auth/` — 6 tests, `auth_handler.go` 4 endpoints |
| 2 | Users (get/update profile) | 1.0 | Tested | `user_handler.go`:14-87, `user_handler_test.go` 4 tests |
| 3 | Guilds (CRUD + auto-setup) | 1.0 | Tested | `guild_handler.go`:19-267, 7 tests, creates @everyone role + general channel |
| 4 | Channels (CRUD, text/voice/category, position) | 1.0 | Tested | `channel_handler.go`:17-244, 6 tests, ChannelType enum, position ordering |
| 5 | Messages (send, list, edit, delete, cursor pagination) | 1.0 | Tested | `message_handler.go`:17-283, 17 tests, before-cursor pagination |
| 6 | Members (list, get, update nick+roles, kick, leave) | 1.0 | Tested | `member_handler.go`:14-262, 11 tests |
| 7 | Roles (CRUD, hierarchy, assign/remove) | 1.0 | Tested | `role_handler.go`:16-291, 9 tests, position/hierarchy checks |
| 8 | Permissions (guild + channel-level) | 1.0 | Tested | `permissions/` — 23 tests, 19 permission bits, 8-layer resolver |
| 9 | Invites (create, accept, list, revoke) | 1.0 | Tested | `invite_handler.go`:15-202, 8 tests, uses tracking |
| 10 | WebSocket Gateway (HELLO→IDENTIFY→READY, heartbeat, RESUME) | 0.5 | No tests | `gateway/manager.go`, `gateway/client.go` — works but 0 unit tests |
| 11 | Gateway Events (all CRUD dispatches) | 1.0 | Tested | 16 dispatch calls verified via mockGateway across handler tests |
| 12 | Typing Indicators | 1.0 | Tested | `message_handler.go` typing endpoint, 2 tests |
| 13 | Rate Limiting (per-IP/per-user, Redis-backed) | 1.0 | Tested | `ratelimit.go`, `ratelimit_test.go` — 4 tests, fail-open on Redis errors |
| 14 | File Uploads (MinIO attachments) | 1.0 | Tested | `upload_handler.go`, `upload_handler_test.go` — 6 tests, 10MB limit, content-type validation |
| 15 | DMs / Private Channels | 0.75 | Partial | `dm_handler.go`, `dm_repo.go`, `dm_channel.go` — 3 endpoints + repo, no handler tests |
| 16 | Ban System | 1.0 | Tested | `ban_handler.go`:16-137, `ban_handler_test.go` — 5 tests, PermBanMembers check |
| 17 | Handler Test Coverage | 1.0 | Complete | 145 tests, 0 failures, race detector clean |

**Total: 16.25 / 17 = 95.6%**

### Key Gaps

1. **Gateway unit tests** — `gateway/` package has 0 tests. Need tests for:
   - Connection lifecycle (HELLO → IDENTIFY → READY)
   - Heartbeat timeout / zombie connection cleanup
   - RESUME with ring buffer replay
   - Guild subscription management
   - `DispatchToGuild()` / `DispatchToUser()` fan-out

2. **DM handler tests** — `dm_handler.go` has 3 endpoints (CreateOrGetDMChannel, ListDMChannels, GetDMChannel) but no test file. Needs mock-based tests following the pattern in `message_handler_test.go`.

### Gap-Filling Instructions

**Gateway tests** (`internal/gateway/manager_test.go`):
```
1. Create mock WebSocket connections using httptest + gorilla/websocket
2. Test HELLO is sent on connect with heartbeat_interval
3. Test IDENTIFY with valid JWT → READY response with guilds list
4. Test heartbeat timeout → connection closed after 2x interval
5. Test RESUME with valid session_id + seq → replayed events from ring buffer
6. Test DispatchToGuild sends event only to subscribed connections
```

**DM tests** (`internal/api/dm_handler_test.go`):
```
1. Follow pattern from message_handler_test.go
2. Test CreateOrGetDMChannel creates new DM channel between two users
3. Test CreateOrGetDMChannel returns existing channel if already exists
4. Test ListDMChannels returns only user's DM channels
5. Test permission: can't DM a user who has blocked you (if implemented)
```

---

## 2. Frontend — 58%

**58 Swift files, ~4,008 lines of code.** XcodeGen project (`project.yml`), builds for iOS Simulator (iPhone 16, iOS 18.4+). `BUILD SUCCEEDED` confirmed.

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Project scaffolded | 1.0 | Complete | `project.yml`, XcodeGen, `Retrocast.xcodeproj`, 58 files |
| 2 | Auth flow (register, login, token management) | 1.0 | Complete | `AuthViewModel`, `TokenManager` (Keychain), `LoginView`, `RegisterView`, `ServerAddressView` |
| 3 | Guild list sidebar | 1.0 | Complete | `ServerListView`, `ServerListViewModel`, `GuildIcon`, wired in `MainView` column 1 |
| 4 | Channel list sidebar | 1.0 | Complete | `ChannelSidebarView`, `ChannelListViewModel` (grouped by category, voice indicators) |
| 5 | Message view + history | 0.75 | UI done | `MessageListView`, `MessageRow`, `DateSeparator` — cursor pagination in VM, not E2E verified |
| 6 | Message send + real-time | 0.75 | UI done | `MessageInput`, `ChatViewModel` — typing throttle, optimistic send, gateway event handling |
| 7 | WebSocket client | 0.75 | Implemented | `GatewayClient` — HELLO→IDENTIFY→READY, heartbeat, reconnect/RESUME, exponential backoff |
| 8 | Member list panel | 0.5 | Unreachable | `MemberListView`, `MemberRow`, `UserProfilePopover` exist but **not wired** into MainView navigation |
| 9 | Typing indicators | 0.75 | UI done | `TypingIndicator` with bouncing dots, `AppState.typingUsers`, `ChatViewModel.startTyping()` |
| 10 | Presence indicators | 0.75 | UI done | `PresenceDot`, `PresenceState`, wired in `MemberRow` and `UserProfilePopover` |
| 11 | Settings UI | 0.5 | Unreachable | `UserSettingsView`, `AppSettingsView`, `SettingsViewModel` exist but **no navigation path** from MainView |
| 12 | Invite system UI | 0.75 | UI done | `InviteSheet`, `CreateGuildSheet`, `JoinGuildSheet`, `InviteViewModel` — all wired and functional |
| 13 | Role management UI | 0.25 | Display only | Roles shown in `GuildSettingsView` list, but GuildSettingsView itself is **unreachable** + no create/edit UI |
| 14 | Responsive layout | 0.75 | Mostly done | `NavigationSplitView` 3-column in `MainView`, adaptive sidebar, needs iPhone testing |

**Total: 10.5 / 14 = 75% code exists → weighted to 58% accounting for unreachable views and no E2E testing**

### Critical Finding: Unreachable Views

Three view groups exist as files but have **no navigation path** from `MainView`:

1. **MemberListView** — Built with role-grouped display, but `MainView` has no button/gesture to show it. Should be column 3 of NavigationSplitView or a sheet toggle.

2. **Settings views** (`UserSettingsView`, `AppSettingsView`) — Complete with logout, theme toggle, profile edit. No gear icon or menu item in any reachable view triggers them.

3. **GuildSettingsView** — Has role list display, guild name edit, danger zone (leave/delete). No long-press or context menu on guild icon opens it.

### Gap-Filling Instructions

**Wire MemberListView** (`Sources/Views/Main/MainView.swift`):
```
Option A: Add as column 3 in NavigationSplitView (iPad gets 3 columns, iPhone collapses)
Option B: Add a toolbar button in ChatView that toggles a trailing sheet/sidebar
Pattern: Follow how ChannelSidebarView is already wired as column 2
```

**Wire Settings** (`Sources/Views/Main/MainView.swift` or `ServerListView.swift`):
```
1. Add a gear icon button at bottom of ServerListView (below guild icons)
2. Present UserSettingsView as a sheet
3. UserSettingsView already has navigation to AppSettingsView
```

**Wire GuildSettingsView** (`Sources/Views/Guild/ServerListView.swift`):
```
1. Add .contextMenu to guild icon buttons in ServerListView
2. Context menu item "Server Settings" presents GuildSettingsView as sheet
3. GuildSettingsView already exists with proper guildID parameter
```

**File upload UI** (new file `Sources/Views/Chat/AttachmentPicker.swift`):
```
1. Add PhotosPicker or UIDocumentPickerViewController wrapper
2. Wire into MessageInput with a paperclip button
3. Upload via APIClient using multipart form data to POST /channels/:id/attachments
4. Display uploaded attachment URL in message or as inline preview
```

**Role management UI** (extend `Sources/Views/Guild/GuildSettingsView.swift`):
```
1. Add "Create Role" button to role list section
2. Create RoleEditorView with name, color picker, permission toggles
3. Wire to POST /guilds/:id/roles and PATCH /guilds/:id/roles/:roleId
4. Permission toggles should map to the 19 bitfield permissions from backend
```

---

## 3. Deployment — 87%

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Dockerfile (multi-stage) | 1.0 | Complete | `Dockerfile` — Go builder → Alpine runtime, 2-stage |
| 2 | docker-compose.yml | 1.0 | Complete | 6 services: api, postgres, redis, minio, livekit, caddy + volumes |
| 3 | CI/CD pipeline | 0.75 | CI only | `.github/workflows/ci.yml` — lint, test, build. No CD (no auto-deploy) |
| 4 | Reverse proxy + TLS | 1.0 | Complete | `Caddyfile` — automatic HTTPS, WebSocket proxy, static files |
| 5 | Production config separation | 1.0 | Complete | `config.go` env-based config, `.env.example` with all vars documented |
| 6 | Structured logging | 1.0 | Complete | `slog.NewJSONHandler` in `main.go`, log levels configurable |
| 7 | Health check endpoint | 1.0 | Complete | `GET /health` returns `{"status":"ok"}` |
| 8 | Automated DB migrations | 1.0 | Complete | `golang-migrate` runs on startup in `main.go`, 10 migration files |
| 9 | Redis persistence | 1.0 | Complete | `--appendonly yes` + named volume in compose |
| 10 | Monitoring (Prometheus) | 0.5 | Partial | `/metrics` endpoint exists but uses basic `expvar`-style handler, no `prometheus/client_golang` collector. No Grafana dashboards. |
| 11 | Backup strategy | 0.5 | Partial | `scripts/backup.sh` with pg_dump, but no cron automation, no MinIO backup |
| 12 | .env support | 1.0 | Complete | `.env.example` — 18 variables documented |
| 13 | Graceful shutdown | 1.0 | Complete | `signal.NotifyContext(SIGINT, SIGTERM)` + `srv.Shutdown()` in `main.go` |

**Total: 11.75 / 13 = 90.4% → scored at 87% accounting for missing CD pipeline and incomplete monitoring**

### Gap-Filling Instructions

**CD pipeline** (`.github/workflows/cd.yml`):
```
1. Trigger on push to main (after CI passes)
2. Build Docker image, push to GitHub Container Registry (ghcr.io)
3. SSH into target host, docker compose pull && docker compose up -d
4. Or use Watchtower for auto-pull on the host
```

**Prometheus metrics** (`internal/api/metrics.go`):
```
1. Add github.com/prometheus/client_golang dependency
2. Create custom collectors: http_requests_total, http_request_duration, ws_connections_active, ws_events_dispatched
3. Register middleware that increments counters per route
4. Replace /metrics handler with promhttp.Handler()
```

**Grafana dashboard** (`deployment/grafana/`):
```
1. Add Grafana service to docker-compose.yml
2. Create provisioning config for Prometheus datasource
3. Create dashboard JSON: request rate, latency percentiles, error rate, WS connections, DB pool stats
```

**Backup automation** (`scripts/backup-cron.sh`):
```
1. Extend backup.sh to include MinIO: mc mirror minio/retrocast /backups/minio/
2. Add retention: find /backups -mtime +7 -delete
3. Add cron entry: 0 3 * * * /opt/retrocast/scripts/backup.sh
4. Document in README or deployment guide
```

---

## Priority Matrix

### P0 — Critical for Usable MVP

| Task | Area | Effort | Why |
|------|------|--------|-----|
| Wire MemberListView into MainView | Frontend | 2 hours | Built but unreachable — users can't see who's online |
| Wire Settings views into navigation | Frontend | 1 hour | Built but unreachable — users can't log out or change settings |
| Wire GuildSettingsView (context menu) | Frontend | 1 hour | Built but unreachable — admins can't manage guilds |
| E2E integration test (frontend ↔ backend) | Frontend | 1 day | Verify the whole stack works together |

### P1 — Important for Quality

| Task | Area | Effort | Why |
|------|------|--------|-----|
| Gateway unit tests | Backend | 1 day | Only untested package, 0 test files in `gateway/` |
| DM handler tests | Backend | 0.5 day | 3 endpoints with no test coverage |
| File upload UI (image picker) | Frontend | 0.5 day | Backend supports it, need PhotosPicker integration |
| Role management UI (create/edit) | Frontend | 1 day | Guild admins need to create and configure roles |
| iPhone layout testing + fixes | Frontend | 0.5 day | Must work on phone, not just iPad simulator |

### P2 — Polish & Extended Features

| Task | Area | Effort | Why |
|------|------|--------|-----|
| CD pipeline (auto-deploy on merge) | Deployment | 0.5 day | Currently CI only, no automated deployment |
| Prometheus client_golang metrics | Deployment | 0.5 day | Current /metrics is basic, need proper collectors |
| Grafana dashboards | Deployment | 0.5 day | Monitoring visibility for ops |
| Message search | Frontend + Backend | 1-2 days | Feature parity with Discord |
| Read states / unread counts | Backend + Frontend | 1-2 days | UX polish — unread badges |
| Voice channels (LiveKit) | Frontend + Backend | 3-5 days | Major feature, LiveKit server already in compose |
| Reactions / embeds | Backend + Frontend | 1-2 days | Rich messaging features |
| Offline persistence | Frontend | 2 days | Local caching for reliability |
| Backup automation (cron + MinIO) | Deployment | 2 hours | Currently manual script only |

---

## Cumulative Progress

| Milestone | Backend | Frontend | Deployment | Overall |
|-----------|---------|----------|------------|---------|
| Session start (initial) | 74% | 5% | 50% | 42% |
| After Sprint 1 autopilot | 94% | 55% | 88% | 77% |
| **Current (fresh audit)** | **96%** | **58%** | **87%** | **79%** |

### Evidence
- `go build ./cmd/retrocast` — compiles clean
- `go test -race ./...` — **145 tests passing**, 0 failures
- `xcodebuild -scheme Retrocast -destination 'iPhone 16,OS=18.4'` — **BUILD SUCCEEDED**
- 58 Swift files, ~4,008 LOC
- PR #4 merged into main with 7 commits (uploads, bans, DMs, tests, deployment, iOS client, docs)
