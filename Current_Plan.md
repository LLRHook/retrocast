# Retrocast — MVP Analysis & Gap Report

> Last updated: 2026-02-15
> Generated by `/analyze` — fresh evidence-based audit

---

## Status Summary

| Area       | Status                        | Completion | Progress                       |
|------------|-------------------------------|------------|--------------------------------|
| Backend    | Feature-complete, fully tested | **100%**   | `████████████████████` |
| Frontend   | Feature-complete               | **100%**   | `████████████████████` |
| Deployment | Solid, minor gaps             | **87%**    | `█████████████████░░░` |
| **Overall**| **~96%**                      |            | `███████████████████░` |

**Overall** is the simple average of all three areas.

---

## 1. Backend — 100%

All 17 MVP features are implemented, wired to the router, dispatching gateway events where applicable, and covered by tests. Total: 46 API endpoints, 20 gateway event types, 14 database migrations, ~4,567 lines of test code.

### Feature Scorecard

| # | Feature | Score | Evidence |
|---|---------|-------|----------|
| 1 | Auth (register, login, refresh, logout) | 1.0 | `auth_handler.go` — 4 endpoints, Argon2id + JWT + refresh rotation. `auth_handler_test.go` (231 lines) |
| 2 | Users (get/update profile) | 1.0 | `user_handler.go` — GetMe, UpdateMe. `user_handler_test.go` (262 lines) |
| 3 | Guilds (CRUD + auto-setup) | 1.0 | `guild_handler.go` — 5 endpoints, auto-creates @everyone role + admin role + #general + voice channel. `guild_handler_test.go` (305 lines) |
| 4 | Channels (CRUD, text/voice/category, position) | 1.0 | `channel_handler.go` — 5 endpoints, ChannelType (0=text, 2=voice, 4=category), position ordering. `channel_handler_test.go` (262 lines) |
| 5 | Messages (send, list, edit, delete, cursor pagination) | 1.0 | `message_handler.go` — 5 endpoints + typing, dual guild/DM support, before-cursor pagination (1-100, default 50). `message_handler_test.go` (640 lines) |
| 6 | Members (list, get, update nick+roles, kick, leave) | 1.0 | `member_handler.go` — 6 endpoints, atomic role assignment, owner protection. `member_handler_test.go` (393 lines) |
| 7 | Roles (CRUD, hierarchy, assign/remove) | 1.0 | `role_handler.go` — 8 endpoints (includes channel overrides), hierarchy enforcement, position-based. `role_handler_test.go` (338 lines) |
| 8 | Permissions (guild + channel-level) | 1.0 | `permissions/resolver.go` — Two-level bitfield system: base (union of roles) + channel overrides (Allow/Deny). Administrator short-circuits. `resolver_test.go` + `bitfield_test.go` |
| 9 | Invites (create, accept, list, revoke) | 1.0 | `invite_handler.go` — 5 endpoints, 8-char hex code, max uses, expiry, ban check on accept. `invite_handler_test.go` (374 lines) |
| 10 | WebSocket Gateway | 1.0 | `gateway/` — HELLO(10)→IDENTIFY(2)→READY(0), heartbeat 41.25s, RESUME(6) with ring buffer (100 events/guild), presence grace period 10s. `manager_test.go` |
| 11 | Gateway Events (all CRUD broadcasts) | 1.0 | 20 event types dispatched from all handlers: MESSAGE_*, GUILD_*, CHANNEL_*, GUILD_MEMBER_*, GUILD_ROLE_*, TYPING_START, PRESENCE_UPDATE, GUILD_BAN_* |
| 12 | Typing Indicators | 1.0 | `POST /channels/:id/typing` + gateway `TYPING_START` dispatch to guild/DM |
| 13 | Rate Limiting | 1.0 | `ratelimit.go` — Redis fixed-window counter via Lua script, 5 req/min (auth) / 50 req/min (protected), fail-open. `ratelimit_test.go` (149 lines) |
| 14 | File Uploads (MinIO) | 1.0 | `upload_handler.go` — 10 MB limit, image/PDF/text validation, S3-compatible storage. `upload_handler_test.go` (301 lines) |
| 15 | DMs / Private Channels | 1.0 | `dm_handler.go` — Create/list DMs, race-safe GetOrCreateDM, recipient-based access. Messages work in DM context. `dm_handler_test.go` (478 lines) |
| 16 | Ban System | 1.0 | `ban_handler.go` — Ban/unban/list, role hierarchy enforcement, auto-kick on ban, prevents rejoin. `ban_handler_test.go` (309 lines) |
| 17 | Handler Test Coverage | 1.0 | 13 handler test files + 6 core test files + 1 testutil. All handlers tested. |

**Total: 17.0 / 17 = 100%**

### Not MVP-Required (out of scope)

- Device tokens (migration 011 exists, no endpoints)
- Voice state updates (Op 4 defined, not handled — LiveKit integration deferred)
- Group DMs (type 3 supported in model, no endpoints)
- Message reactions/emojis, pinned messages, audit log

---

## 2. Frontend — 100%

The iOS/macOS client (`retrocast-client/Retrocast/`) is a complete SwiftUI app targeting iOS 17+ / Swift 6.0 with MVVM architecture, @Observable state management, and full gateway integration.

### Feature Scorecard

| # | Feature | Score | Evidence |
|---|---------|-------|----------|
| 1 | Project scaffolded | 1.0 | `project.yml` (XcodeGen), iOS 17.0, Swift 6.0, no external SPM dependencies |
| 2 | Auth flow | 1.0 | `AuthViewModel` + `ServerAddressView` → `LoginView`/`RegisterView` → auto-login. `TokenManager` stores in Keychain. `APIClient` coalesces 401 refresh. |
| 3 | Guild list sidebar | 1.0 | `ServerListView` — guild icons with selection pill, create/join sheets, context menu for server settings |
| 4 | Channel list sidebar | 1.0 | `ChannelSidebarView` — grouped by category, voice channel indicators, auto-selects first text channel |
| 5 | Message view with history | 1.0 | `MessageListView` — cursor pagination via `Color.clear` sentinel + `.onAppear` → `loadMoreMessages()`, date separators, 5-min message grouping. Edit via alert + `onEdit` closure. Delete via `onDelete` closure. |
| 6 | Message send + real-time | 1.0 | `MessageInput` — multiline TextField, PhotosPicker for image upload, typing throttle (8s). Real-time delivery via gateway MESSAGE_CREATE → AppState.addMessage |
| 7 | WebSocket client | 1.0 | `GatewayClient` — HELLO→IDENTIFY→READY, heartbeat loop, RESUME with sessionID + sequence, exponential backoff with jitter (1s base, 60s max, 10 attempts) |
| 8 | Member list panel | 1.0 | `MemberListView` (200dp sidebar) — grouped by highest role. `MemberRow` with tap → `UserProfilePopover` (presence, roles, join date) |
| 9 | Typing indicators | 1.0 | `TypingIndicator` — bouncing dots animation, "X is typing..." / "X and Y are typing..." / "Several people are typing...", 8s auto-remove |
| 10 | Presence indicators | 1.0 | `PresenceDot` — online (green), idle (yellow), dnd (red), offline (gray). Wired in `MemberRow` and `UserProfilePopover` |
| 11 | Settings | 1.0 | `UserSettingsView` — profile display, edit display name, save. `AppSettingsView` reachable via button → sheet. Logout. |
| 12 | Invite system UI | 1.0 | `InviteSheet` — generate invite code, copy to clipboard, view active invites with usage stats, revoke invites |
| 13 | Role/permission management | 1.0 | `RoleEditorView` — name field, color picker, 19 permission toggles in 4 groups (General/Membership/Text/Voice), create/edit/delete. Wired via `GuildSettingsView` |
| 14 | Responsive/adaptive layout | 1.0 | `MainView` — `NavigationSplitView` 3-column (iPad) / 2-column (iPhone), toggleable member sidebar, dark Retrocast theme |

**Total: 14.0 / 14 = 100%**

### Attachment Rendering

`MessageRow.swift` handles attachments properly:
- Images: `AsyncImage` with aspect-fit, 300x300 max, rounded corners, loading/error states
- Files: document icon + filename + formatted file size

### Not MVP-Required (polish items)

| Item | Status | Notes |
|------|--------|-------|
| Avatar image loading | Initials only | `AvatarView` accepts `avatarHash` but doesn't fetch images from server |
| DM UI | Backend ready, no client UI | No DM list view or DM conversation screen |
| Channel creation/edit UI | No UI | API exists, no button in `ChannelSidebarView` |
| Markdown rendering | `MarkdownParser.swift` exists | Not integrated into `MessageRow` |
| macOS clipboard | `UIPasteboard` iOS-only | Needs `#if os()` conditional for macOS target |
| Message search | Not implemented | No search UI or backend endpoint |

---

## 3. Deployment — 87%

### Feature Scorecard

| # | Feature | Score | Status | Evidence |
|---|---------|-------|--------|----------|
| 1 | Dockerfile (multi-stage) | 1.0 | Complete | 2-stage (golang:1.25-alpine → alpine:3.21), non-root user (appuser:1001), `CGO_ENABLED=0`, HEALTHCHECK, `.dockerignore` |
| 2 | docker-compose.yml | 1.0 | Complete | 7 services (api, postgres:17, redis:7-alpine, minio, livekit, caddy:2-alpine), named volumes, `env_file: .env`, `restart: unless-stopped` on all, healthchecks on api + db |
| 3 | CI/CD pipeline | 0.5 | CI only | `ci.yml` — `go test -v -race ./...` + `go build` on push/PR with Postgres+Redis services. No lint, no Docker build/push, no CD. |
| 4 | Reverse proxy + TLS | 1.0 | Complete | `Caddyfile` — `{$DOMAIN:localhost}` → auto-HTTPS. `caddy_data` volume for cert persistence. |
| 5 | Production config separation | 1.0 | Complete | `config.go` — env vars only, panics on missing `DATABASE_URL`/`JWT_SECRET`. `.env.example` provided. No hardcoded secrets. |
| 6 | Structured logging | 1.0 | Complete | `slog.NewJSONHandler()` to stdout, configurable via `LOG_LEVEL` env var (debug/info/warn/error). Gateway fully migrated to slog (16 calls across 3 files). |
| 7 | Health check endpoint | 0.75 | Partial | `GET /health` returns `{"status":"ok"}`, used by Dockerfile HEALTHCHECK + compose healthcheck. Shallow — doesn't ping DB or Redis. |
| 8 | Automated DB migrations | 1.0 | Complete | `golang-migrate/v4` — 14 migration pairs, auto-applied on startup, exits on failure, idempotent |
| 9 | Redis persistence | 1.0 | Complete | `--appendonly yes` + `redis-data` volume |
| 10 | Monitoring (Prometheus) | 0.5 | Partial | `GET /metrics` via `echoprometheus` middleware (HTTP request metrics). No Prometheus server or Grafana in compose. |
| 11 | Backup strategy | 0.5 | Partial | `scripts/backup.sh` — `pg_dump | gzip` with timestamp. No automation, no retention, no MinIO backup, no restore script. |
| 12 | .env support | 1.0 | Complete | `env_file: .env` in compose, `os.Getenv()` in Go, `.env.example` template, `.env` gitignored |
| 13 | Graceful shutdown | 1.0 | Complete | `signal.NotifyContext(SIGINT, SIGTERM)` → `e.Shutdown()` + deferred `pool.Close()` + `rdb.Close()` |

**Total: 11.25 / 13 = 86.5% ≈ 87%**

### Gap-Filling Instructions

**1. Add Linting to CI** (CI → 0.75)

Edit `.github/workflows/ci.yml`, add step before tests:
```yaml
- name: Lint
  uses: golangci/golangci-lint-action@v6
  with:
    working-directory: retrocast
```

**2. Add Docker Build to CI** (CI → 1.0)

Add job to `.github/workflows/ci.yml`:
```yaml
docker:
  needs: test
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'
  steps:
    - uses: actions/checkout@v4
    - uses: docker/build-push-action@v5
      with:
        context: retrocast
        push: false
        tags: retrocast:${{ github.sha }}
```

**3. Deep Health Check** (Health → 1.0)

Modify `internal/api/router.go` health endpoint to ping DB pool and Redis client:
```go
e.GET("/health", func(c echo.Context) error {
    ctx := c.Request().Context()
    if err := deps.Pool.Ping(ctx); err != nil {
        return c.JSON(503, map[string]string{"status": "unhealthy", "component": "postgres"})
    }
    if err := deps.Redis.Ping(ctx).Err(); err != nil {
        return c.JSON(503, map[string]string{"status": "unhealthy", "component": "redis"})
    }
    return c.JSON(200, map[string]string{"status": "ok"})
})
```

**4. Add Prometheus + Grafana** (Monitoring → 1.0)

Add to `docker-compose.yml`:
```yaml
prometheus:
  image: prom/prometheus:latest
  volumes:
    - ./prometheus.yml:/etc/prometheus/prometheus.yml
    - prometheus-data:/prometheus
  ports:
    - "9090:9090"
  restart: unless-stopped
```

Create `retrocast/prometheus.yml`:
```yaml
scrape_configs:
  - job_name: retrocast
    static_configs:
      - targets: ['api:8080']
    scrape_interval: 15s
```

**5. Automate Backups** (Backup → 1.0)

- Create `scripts/restore.sh` for restore from backup
- Add MinIO backup via `mc mirror` in `backup.sh`
- Add retention: delete backups older than 30 days
- Document cron setup: `0 3 * * * /path/to/backup.sh`

---

## Priority Matrix

### P0 — Ship Blockers

None. The MVP is feature-complete across all three areas.

### P1 — Production Hardening

| Task | Area | Effort | Impact |
|------|------|--------|--------|
| Deep health check (DB + Redis ping) | Deployment | 30 min | Detect service failures |
| Add linting to CI | Deployment | 15 min | Code quality gate |
| Docker build in CI | Deployment | 30 min | Verify Dockerfile on every push |
| Prometheus server in compose | Deployment | 1 hour | Monitoring visibility |
| Backup automation | Deployment | 1 hour | Data safety |

### P2 — Polish & Extended Features

| Task | Area | Effort | Impact |
|------|------|--------|--------|
| Avatar image loading | Frontend | 2 hours | User profile pictures |
| DM UI (list + conversation) | Frontend | 4 hours | Backend already supports DMs |
| Channel creation UI | Frontend | 2 hours | Currently admin-only via API |
| Markdown rendering in messages | Frontend | 2 hours | Rich text display |
| macOS clipboard compatibility | Frontend | 30 min | `#if os()` conditional |
| Rate limit response headers | Backend | 1 hour | Client-side awareness |
| CD pipeline (auto-deploy) | Deployment | 4 hours | Automated deployment |
| Voice channels (LiveKit) | Both | 3-5 days | Major feature, infrastructure ready |
| Message search | Both | 1-2 days | Feature parity |
| Read states / unread badges | Both | 1-2 days | UX polish |

---

## Cumulative Progress

| Milestone | Backend | Frontend | Deployment | Overall |
|-----------|---------|----------|------------|---------|
| Session start (initial) | 74% | 5% | 50% | 43% |
| After Sprint 1 autopilot | 94% | 55% | 88% | 79% |
| After P0+P1 sprint | 96% | 58% | 87% | 80% |
| Previous audit | 100% | 92% | 65% | 86% |
| **Current (fresh audit)** | **100%** | **100%** | **87%** | **96%** |

### What Changed Since Last Audit

The previous audit (earlier today) reported Frontend at 92% and Deployment at 65%. Those scores were stale — the code has been updated:

**Frontend fixes verified:**
- Message pagination scroll trigger: **wired** (`MessageListView.swift:19-28` — Color.clear sentinel with `.onAppear`)
- Message edit/delete: **wired** (`MessageListView.swift:49-69` — `onEdit`/`onDelete` closures call ChatViewModel)
- UserProfilePopover: **wired** (`MemberRow.swift:34-40` — `.onTapGesture` + `.popover`)
- AppSettingsView: **reachable** (`UserSettingsView.swift:58-61` — button + `.sheet`)
- Attachment rendering: **complete** (`MessageRow.swift:57-95` — AsyncImage for images, doc icon for files)
- RoleEditorView: **complete** (`RoleEditorView.swift` — 19 permission toggles in 4 groups, name, color, CRUD)

**Deployment fixes verified:**
- Dockerfile: **has** non-root user, HEALTHCHECK, .dockerignore (previously reported missing)
- docker-compose: **has** `env_file: .env`, `restart: unless-stopped`, API healthcheck (previously reported missing)
- Gateway logging: **fully migrated** to slog — 0 `log.Printf` calls remain (previously reported 17)
- Config: **panics** on missing JWT_SECRET/DATABASE_URL (previously reported "silent fallback")
